<div class="header-block block">
  <div class="inner-block organisation-logo">
    <%= render_organisation_title @organisation %>
  </div>
</div>

<div class="block selector-block">
  <div class="inner-block floated-children">
    <div class="select-options">
      <div class="inner-floated">
        <h2>Filter:</h2>
        <form method="get" action="" class="date">
          <input type="hidden" name="site" value="<%= params[:site] %>">
          <input type="hidden" name="host" value="<%= params[:host] %>">
          <p class="label">Date Range:</p>
          <ul>
            <li><%= link_to 'Yesterday', page_path(site: params[:site], host: params[:host]) %></li>
            <li><%= link_to 'Last week', page_path(site: params[:site], host: params[:host], start: 7.days.ago.strftime('%Y-W%U')) %></li>
            <li><label for="date">Date:</label> <input class="date-input" name="date" placeholder="yyyy-mm-dd"> <input type="submit"></li>
          </ul>
        </form>
        <form method="get" action="" class="single-input-form">
          <label for="site">Site:</label>
          <select name="site">
            <option value="">Pick a site</option>
            <%= options_for_select(@organisation.sites.map { |site| [site.site, site.id] }, @site && @site.id ) %>
          </select>
          <input type="submit">
        </form>
        <form method="get" action="" class="single-input-form">
          <label for="host">Host:</label>
          <input type="hidden" name="site" value="<%= params[:site] %>">
          <select name="host"<%= " disabled" unless @site %>>
            <option value="">Pick a host</option>
            <% if @site %>
              <%= options_for_select(@site.hosts.map { |host| [host.host, host.id] }, @host && @host.id ) %>
            <% end %>
          <input type="submit">
          </select>
      </div>
    </div>
    <div class="date-graph">
      <div class="inner-floated">
        <p>Click a column to pick a weeks view:</p>
        <%= render partial: 'totals/stacked', locals: { link_lists: true } %>
      </div>
    </div>
  </div>
</div>

<div class="block js-pages">
  <div class="inner-block">
    <% unless  @most_recent_hit_data.hits.any? %>
      <h1>We don't have requests for that time period yet</h1>
      <p>Please select a different date range.</p>
    <% else %>
      <h1>Page requests from <%= @start_date.to_date.to_s(:long_ordinal) %><%= " to #{@end_date.to_date.to_s(:long_ordinal)}" if @end_date %></h1>
      <div class="filter-block js-hidden js-pages-navigation">
        <ol>
          <li class="all active"><a href="#">All</a></li>
          <li class="gone"><a href="#gone">Archive</a></li>
          <li class="error"><a href="#error">Error</a></li>
          <li class="redirect"><a href="#redirect">Redirect</a></li>
          <li class="ok"><a href="#ok">Ok</a></li>
        </ol>
      </div>
      <%= render partial: 'hits/graph' %>
      <table class="hit-table js-pages-table">
        <thead>
          <tr>
            <th>Percent</th>
            <th>Hits</th>
            <th>Status</th>
            <th>Path</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @most_recent_hit_data.hits.each.with_index do |hit, i| %>
            <tr id="hit-<%= i %>"
              data-percent="<%= number_to_percentage((hit.count / @most_recent_hit_data.total_hits.to_f) * 100.0, precision: 2) %>"
              data-type="<%= categorize_http_status(hit.http_status) %>"
              data-url="<%= 'http://' + hit.host.host + hit.path %>"
              class="<%= categorize_http_status(hit.http_status) %>">
              <td><%= number_to_percentage((hit.count / @most_recent_hit_data.total_hits.to_f) * 100.0, precision: 2) %></td>
              <td><%= hit.count %></td>
              <td class="type"><%= categorize_http_status(hit.http_status) %></td>
              <td title="<%= 'http://' + hit.host.host + hit.path %>"><%= truncate(@host.nil? ? "#{hit.host.host}#{hit.path}" : hit.path, length: 80) %></td>
              <td class="actions"><a href="<%= 'http://' + hit.host.host + hit.path %>">visit</a></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

<% content_for :page_title do %>
  Requests - <%= @organisation.title %>
<% end %>
